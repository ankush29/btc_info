{"ast":null,"code":"var util = require('util'),\n    net = require('net'),\n    tls = require('tls'),\n    url = require('url'),\n    driver = require('websocket-driver'),\n    API = require('./api'),\n    Event = require('./api/event');\n\nvar DEFAULT_PORTS = {\n  'http:': 80,\n  'https:': 443,\n  'ws:': 80,\n  'wss:': 443\n},\n    SECURE_PROTOCOLS = ['https:', 'wss:'];\n\nvar Client = function Client(_url, protocols, options) {\n  options = options || {};\n  this.url = _url;\n  this._driver = driver.client(this.url, {\n    maxLength: options.maxLength,\n    protocols: protocols\n  });\n  ['open', 'error'].forEach(function (event) {\n    this._driver.on(event, function () {\n      self.headers = self._driver.headers;\n      self.statusCode = self._driver.statusCode;\n    });\n  }, this);\n\n  var proxy = options.proxy || {},\n      endpoint = url.parse(proxy.origin || this.url),\n      port = endpoint.port || DEFAULT_PORTS[endpoint.protocol],\n      secure = SECURE_PROTOCOLS.indexOf(endpoint.protocol) >= 0,\n      onConnect = function onConnect() {\n    self._onConnect();\n  },\n      originTLS = options.tls || {},\n      socketTLS = proxy.origin ? proxy.tls || {} : originTLS,\n      self = this;\n\n  originTLS.ca = originTLS.ca || options.ca;\n  this._stream = secure ? tls.connect(port, endpoint.hostname, socketTLS, onConnect) : net.connect(port, endpoint.hostname, onConnect);\n  if (proxy.origin) this._configureProxy(proxy, originTLS);\n  API.call(this, options);\n};\n\nutil.inherits(Client, API);\n\nClient.prototype._onConnect = function () {\n  var worker = this._proxy || this._driver;\n  worker.start();\n};\n\nClient.prototype._configureProxy = function (proxy, originTLS) {\n  var uri = url.parse(this.url),\n      secure = SECURE_PROTOCOLS.indexOf(uri.protocol) >= 0,\n      self = this,\n      name;\n  this._proxy = this._driver.proxy(proxy.origin);\n\n  if (proxy.headers) {\n    for (name in proxy.headers) {\n      this._proxy.setHeader(name, proxy.headers[name]);\n    }\n  }\n\n  this._proxy.pipe(this._stream, {\n    end: false\n  });\n\n  this._stream.pipe(this._proxy);\n\n  this._proxy.on('connect', function () {\n    if (secure) {\n      var options = {\n        socket: self._stream,\n        servername: uri.hostname\n      };\n\n      for (name in originTLS) {\n        options[name] = originTLS[name];\n      }\n\n      self._stream = tls.connect(options);\n\n      self._configureStream();\n    }\n\n    self._driver.io.pipe(self._stream);\n\n    self._stream.pipe(self._driver.io);\n\n    self._driver.start();\n  });\n\n  this._proxy.on('error', function (error) {\n    self._driver.emit('error', error);\n  });\n};\n\nmodule.exports = Client;","map":null,"metadata":{},"sourceType":"script"}