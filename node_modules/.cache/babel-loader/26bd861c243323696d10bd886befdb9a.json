{"ast":null,"code":"'use strict';\n\nvar Buffer = require('safe-buffer').Buffer,\n    Base = require('./base'),\n    util = require('util');\n\nvar Draft75 = function Draft75(request, url, options) {\n  Base.apply(this, arguments);\n  this._stage = 0;\n  this.version = 'hixie-75';\n\n  this._headers.set('Upgrade', 'WebSocket');\n\n  this._headers.set('Connection', 'Upgrade');\n\n  this._headers.set('WebSocket-Origin', this._request.headers.origin);\n\n  this._headers.set('WebSocket-Location', this.url);\n};\n\nutil.inherits(Draft75, Base);\nvar instance = {\n  close: function close() {\n    if (this.readyState === 3) return false;\n    this.readyState = 3;\n    this.emit('close', new Base.CloseEvent(null, null));\n    return true;\n  },\n  parse: function parse(chunk) {\n    if (this.readyState > 1) return;\n\n    this._reader.put(chunk);\n\n    this._reader.eachByte(function (octet) {\n      var message;\n\n      switch (this._stage) {\n        case -1:\n          this._body.push(octet);\n\n          this._sendHandshakeBody();\n\n          break;\n\n        case 0:\n          this._parseLeadingByte(octet);\n\n          break;\n\n        case 1:\n          this._length = (octet & 0x7F) + 128 * this._length;\n\n          if (this._closing && this._length === 0) {\n            return this.close();\n          } else if ((octet & 0x80) !== 0x80) {\n            if (this._length === 0) {\n              this._stage = 0;\n            } else {\n              this._skipped = 0;\n              this._stage = 2;\n            }\n          }\n\n          break;\n\n        case 2:\n          if (octet === 0xFF) {\n            this._stage = 0;\n            message = Buffer.from(this._buffer).toString('utf8', 0, this._buffer.length);\n            this.emit('message', new Base.MessageEvent(message));\n          } else {\n            if (this._length) {\n              this._skipped += 1;\n              if (this._skipped === this._length) this._stage = 0;\n            } else {\n              this._buffer.push(octet);\n\n              if (this._buffer.length > this._maxLength) return this.close();\n            }\n          }\n\n          break;\n      }\n    }, this);\n  },\n  frame: function frame(buffer) {\n    if (this.readyState === 0) return this._queue([buffer]);\n    if (this.readyState > 1) return false;\n    if (typeof buffer !== 'string') buffer = buffer.toString();\n    var length = Buffer.byteLength(buffer),\n        frame = Buffer.allocUnsafe(length + 2);\n    frame[0] = 0x00;\n    frame.write(buffer, 1);\n    frame[frame.length - 1] = 0xFF;\n\n    this._write(frame);\n\n    return true;\n  },\n  _handshakeResponse: function _handshakeResponse() {\n    var start = 'HTTP/1.1 101 Web Socket Protocol Handshake',\n        headers = [start, this._headers.toString(), ''];\n    return Buffer.from(headers.join('\\r\\n'), 'utf8');\n  },\n  _parseLeadingByte: function _parseLeadingByte(octet) {\n    if ((octet & 0x80) === 0x80) {\n      this._length = 0;\n      this._stage = 1;\n    } else {\n      delete this._length;\n      delete this._skipped;\n      this._buffer = [];\n      this._stage = 2;\n    }\n  }\n};\n\nfor (var key in instance) {\n  Draft75.prototype[key] = instance[key];\n}\n\nmodule.exports = Draft75;","map":null,"metadata":{},"sourceType":"script"}