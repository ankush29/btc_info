{"ast":null,"code":"'use strict';\n\nvar Buffer = require('safe-buffer').Buffer,\n    Stream = require('stream').Stream,\n    url = require('url'),\n    util = require('util'),\n    Base = require('./base'),\n    Headers = require('./headers'),\n    HttpParser = require('../http_parser');\n\nvar PORTS = {\n  'ws:': 80,\n  'wss:': 443\n};\n\nvar Proxy = function Proxy(client, origin, options) {\n  this._client = client;\n  this._http = new HttpParser('response');\n  this._origin = typeof client.url === 'object' ? client.url : url.parse(client.url);\n  this._url = typeof origin === 'object' ? origin : url.parse(origin);\n  this._options = options || {};\n  this._state = 0;\n  this.readable = this.writable = true;\n  this._paused = false;\n  this._headers = new Headers();\n\n  this._headers.set('Host', this._origin.host);\n\n  this._headers.set('Connection', 'keep-alive');\n\n  this._headers.set('Proxy-Connection', 'keep-alive');\n\n  var auth = this._url.auth && Buffer.from(this._url.auth, 'utf8').toString('base64');\n  if (auth) this._headers.set('Proxy-Authorization', 'Basic ' + auth);\n};\n\nutil.inherits(Proxy, Stream);\nvar instance = {\n  setHeader: function setHeader(name, value) {\n    if (this._state !== 0) return false;\n\n    this._headers.set(name, value);\n\n    return true;\n  },\n  start: function start() {\n    if (this._state !== 0) return false;\n    this._state = 1;\n    var origin = this._origin,\n        port = origin.port || PORTS[origin.protocol],\n        start = 'CONNECT ' + origin.hostname + ':' + port + ' HTTP/1.1';\n    var headers = [start, this._headers.toString(), ''];\n    this.emit('data', Buffer.from(headers.join('\\r\\n'), 'utf8'));\n    return true;\n  },\n  pause: function pause() {\n    this._paused = true;\n  },\n  resume: function resume() {\n    this._paused = false;\n    this.emit('drain');\n  },\n  write: function write(chunk) {\n    if (!this.writable) return false;\n\n    this._http.parse(chunk);\n\n    if (!this._http.isComplete()) return !this._paused;\n    this.statusCode = this._http.statusCode;\n    this.headers = this._http.headers;\n\n    if (this.statusCode === 200) {\n      this.emit('connect', new Base.ConnectEvent());\n    } else {\n      var message = \"Can't establish a connection to the server at \" + this._origin.href;\n      this.emit('error', new Error(message));\n    }\n\n    this.end();\n    return !this._paused;\n  },\n  end: function end(chunk) {\n    if (!this.writable) return;\n    if (chunk !== undefined) this.write(chunk);\n    this.readable = this.writable = false;\n    this.emit('close');\n    this.emit('end');\n  },\n  destroy: function destroy() {\n    this.end();\n  }\n};\n\nfor (var key in instance) {\n  Proxy.prototype[key] = instance[key];\n}\n\nmodule.exports = Proxy;","map":null,"metadata":{},"sourceType":"script"}